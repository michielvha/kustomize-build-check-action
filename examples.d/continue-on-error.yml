name: Kustomize Check - Continue on Error

on:
  pull_request:
    paths:
      - '**/*.yaml'
      - '**/*.yml'

jobs:
  validate:
    name: Validate and Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Run Kustomize Build Check
        id: kustomize
        uses: michielvha/kustomize-build-check-action@main
        with:
          enable-helm: true
          fail-on-error: false  # Don't fail the workflow
        continue-on-error: true
      
      - name: Comment on PR with Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const successCount = '${{ steps.kustomize.outputs.success-count }}';
            const failedCount = '${{ steps.kustomize.outputs.failed-count }}';
            
            let body = '## Kustomize Build Results\n\n';
            body += `âœ… Successful: ${successCount}\n`;
            body += `âŒ Failed: ${failedCount}\n\n`;
            
            if (failedCount > 0) {
              body += 'âš ï¸ Some kustomize builds failed. Please review the workflow logs.\n';
            } else {
              body += 'ðŸŽ‰ All kustomize builds passed!\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Send Slack Notification
        if: steps.kustomize.outputs.failed-count > 0
        # uses: your-slack-action
        run: echo "Would send Slack notification about ${{ steps.kustomize.outputs.failed-count }} failed builds"
